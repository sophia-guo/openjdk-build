# Build Stages Template
#
# supported platform & versions:
#    macOS: jdk11u, jdk13u, and jdk
#    windows: jdk8u, jdk11u, jdk13u, and jdk
#
# required pipeline level variable(s):
#    JAVA_TO_BUILD: jdk8u|jdk11u|jdk13u|jdk
# 
# optional pipeline level variable(s):
#    EXTRA_MAKEJDK_ANY_PLATFORM_OPTIONS: other options in makejdk-any-platform.sh
#
# required stage level variable(s):
#    TARGET_OS: mac|windows
#    ARCHITECTURE: x64|x86-32
#
# Azure DevOps Microsoft-Hosted agents can be found at:
# https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted
#
stages:
  - stage: build_macOS_x64_hotspot_binaries
    variables:
      skipComponentGovernanceDetection: true
      TARGET_OS: "mac"
      ARCHITECTURE: "x64"
    displayName: "Build macOS x64 HotSpot Binaries"
    dependsOn: []
    # jdk8u cannot be built on macOS 10.14 or 10.13
    condition: ne(variables.JAVA_TO_BUILD, 'jdk8u')
    jobs:
      - job: build_macOS
        displayName: "Build macOS x64 HotSpot"
        pool:
          vmImage: macOS-10.14
        steps:
          - template: ./steps/shared/pre.yml
          - template: ./steps/macOS/pre.yml
          - template: ./steps/macOS/build_hotspot.yml
          - template: ./steps/shared/post.yml

  - stage: build_windows_x64_hotspot_binaries
    variables:
      skipComponentGovernanceDetection: true
      TARGET_OS: "windows"
      ARCHITECTURE: "x64"
    displayName: "Build Windows x64 HotSpot Binaries"
    dependsOn: []
    jobs:
      - job: build_macOS
        timeoutInMinutes: 120
        displayName: "Build Windows x64 HotSpot"
        pool:
          vmImage: vs2017-win2016
        steps:
          - template: ./steps/shared/pre.yml
          - template: ./steps/windows/pre.yml
          - template: ./steps/windows/build_hotspot.yml
          - template: ./steps/shared/post.yml

  - stage: build_windows_x86_hotspot_binaries
    variables:
      skipComponentGovernanceDetection: true
      TARGET_OS: "windows"
      ARCHITECTURE: "x86-32"
    displayName: "Build Windows x86 HotSpot Binaries"
    dependsOn: []
    jobs:
      - job: build_macOS
        timeoutInMinutes: 120
        displayName: "Build Windows x86 HotSpot"
        pool:
          vmImage: vs2017-win2016
        steps:
          - template: ./steps/shared/pre.yml
          - template: ./steps/windows/pre.yml
          - template: ./steps/windows/build_hotspot.yml
          - template: ./steps/shared/post.yml
